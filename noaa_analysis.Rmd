---
title: Health and Economic Impact of Severe Weather Events Across the USA - Exploring
  the NOAA Storm Database
output:
  html_document:
    df_print: paged
---

## Synopsis

This project is intented to target the exploration of the NOAA Storm Database to understand the impact on public health and overall economics of severe weather events, like tornados, drought, snow, rainfalls, in several categories. Two basic questions are adressed by this report:

1. Across the United States, which types of events are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

This repost will try to answer these questions showing relevant data and their graphical interpretion. Working software code will be available as well, to help with its reproducibility.

## Data Processing

```{r echo=TRUE, message=FALSE, comment=FALSE, results=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
```

The data for this project is available from this link
```{r echo=TRUE, message=FALSE, cache=TRUE, comment=FALSE, results=FALSE}
dest_file <- "StormData.csv.bz2"
if (!file.exists(dest_file)) {
        url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
        download.file(url, destfile = dest_file)
        download_timestamp <- timestamp()
        write(download_timestamp, file = "download_timestamp.txt")
}
download_timestamp <- read.delim("download_timestamp.txt", header = FALSE)
```

File *`r dest_file`* was downloaded on

> `r gsub("  ", " ", gsub("#| ?-+ ?", "", unlist(download_timestamp)))`

```{r cache=TRUE}
dataset <- read.csv(dest_file)
```

A sample from the original dataset is shown below
```{r echo=TRUE}
head(dataset)
```

The dataset has `r dim(dataset)[1]` records. 

### Types of Events Most Harmful to Population Health

The relevant fields to answer this first question are
 
> EVTYPE &rarr; EventType (renamed)  
> FATALITIES  
> INJURIES  

A fourth field, *Casualties*, with the sum of FATALITIES and INJURIES, will be created, to give a broad view of the
health hazard presented by each event type. Also, the top ten event types will be used to identify the most impacting weather events.

The calculation below prepares the data for the final results section

```{r echo=TRUE, cache=TRUE, comment=FALSE, message=FALSE, results=FALSE}
health_impact_set <- dataset %>%
                select(EVTYPE, FATALITIES, INJURIES) %>%
                mutate(Casualties = (FATALITIES + INJURIES) / 1e3, EventType = tolower(EVTYPE))
agg <- aggregate(Casualties ~ EventType, data = health_impact_set, FUN = sum)
most_impacting_events <- agg %>%
        arrange(desc(Casualties)) %>%
        top_n(10)
most_impacting_events[most_impacting_events$EventType == "tstm wind", "EventType"] = "marine thunderstorm wind"
```

### Types of Events Most Harmful to the Economy

The relevant fields to answer the second question are
  
> EVTYPE &rarr; EventType (renamed)  
> PROPDMG  
> PROPDMGEXP  
> CROPDMG  
> CROPDMGEXP  

A field called *EconomicCost*, with the calculation 

> PROPDMG x PROPDMGEXP + CROPDMG x CROPDMGEXP

will be created, to give a view of the total economic impact presented by each event type. Also, the top ten event types will be used to identify the most impacting weather events.

The values in the fields PROPDMGEXP and CROPDMGEXP will be replaced following the logic

> k or K &rarr; 1x10<sup>3</sup>  
> m or M &rarr; 1x10<sup>6</sup>  
> b or B &rarr; 1x10<sup>9</sup>  
> h or H &rarr; 1x10<sup>5</sup>  
> 0, +, - or empty &rarr; 1  
> any number will remain the same  

as seen in the function *multiplier*

```{r echo=TRUE}
multiplier <- function(type) {
        mul <- tolower(as.character(type))
        switch(ifelse(mul == '', '1', mul),
               'k' = 1e3,
               'm' = 1e6,
               'b' = 1e9,
               'h' = 1e5,
               '+' = 1,
               '-' = 1,
               '0' = 1,
               as.numeric(type))
}
```

The calculation below prepares the data for the final results section

```{r cache=TRUE, comment=FALSE, message=FALSE, results=FALSE}
economic_impact_set <- dataset %>%
                select(EVTYPE, PROPDMG, CROPDMG) %>%
                mutate(EventType = EVTYPE,
                       PropDmg = PROPDMG,
                       CropDmg = CROPDMG) %>%
                select(EventType, PropDmg, CropDmg)

economic_impact_set$PropDmgMul <- dataset$PROPDMGEXP %>%
        sapply(multiplier)
economic_impact_set$CropDmgMul <- dataset$CROPDMGEXP %>%
        sapply(multiplier)
economic_impact_set <- economic_impact_set %>%
        mutate(EconomicCost = (PropDmg * PropDmgMul + CropDmg * CropDmgMul) / 1e9)

econ_agg <- aggregate(EconomicCost ~ EventType, data = economic_impact_set, FUN = sum)
most_economic_impacting_events <- econ_agg %>%
        arrange(desc(EconomicCost)) %>%
        select(EventType, EconomicCost) %>%
        mutate(EventType = tolower(EventType)) %>%
        top_n(10)
```

## Results

### Human Health Impact

The top ten event types that impact human health are shown below. By far, tornadoes are the most impact severe weather event, with `r format(most_impacting_events[most_impacting_events$EventType == 'tornado', 'Casualties']/sum(most_impacting_events[, 'Casualties']) * 100, digits = 3, nsmall = 1)`% of the total number of casualties.
```{r}
g <- most_impacting_events %>% ggplot(aes(x = reorder(EventType, Casualties), Casualties))
g + geom_bar(stat = "identity", aes(color = EventType, fill = EventType)) +
        theme(legend.position = "none") +
        ggtitle("Number of Casualties per Event Type") +
        ylab("Casualties (in thousands)") +
        xlab("Event Type") +
        scale_y_continuous(limits = c(0, 100)) +
        coord_flip() +
        geom_text(aes(y = Casualties + 1,
                      label = format(Casualties, digits = 2, nsmall = 1, big.mark = ",", scientific = FALSE),
                      hjust = "left"), colour = "darkgrey")
```

### Economic Impact

The highest economic impact is caused by floods, while the other 9 top severe weather events trailing behind with, at most, less than half of floods' cost. 
```{r}
g <- most_economic_impacting_events %>% ggplot(aes(x = reorder(EventType, EconomicCost), EconomicCost))
g + geom_bar(stat = "identity", aes(color = EventType, fill = EventType)) +
        theme(legend.position = "none") +
        ggtitle("Economic Cost per Event Type") +
        ylab("Cost (in US$ billions)") +
        xlab("Event Type") +
        scale_y_continuous(limits = c(0, 157)) +
        coord_flip() +
        geom_text(aes(y = EconomicCost + 1,
                      label = format(EconomicCost, digits = 3, nsmal = 1, big.mark = ",", scientific = FALSE),
                      hjust = "left"), colour = "darkgrey")

```
